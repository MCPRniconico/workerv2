<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鉄道高校情報 - アクセス認証</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onloadTurnstileCallback" async defer></script>
</head>
<body>

    <div id="captcha-section" class="container">
        <h1>アクセス認証が必要です</h1>
        <p>あなたがロボットではないことを確認しています</p>
        
        <form id="captcha-form">
            <div id="invisible-turnstile-container"></div>
            <input type="hidden" name="cf-turnstile-response" id="cf-turnstile-response-hidden">
            <noscript>
                <p>JavaScriptを有効にしてください。</p>
            </noscript>
        </form>
        
        <div id="loading-message" style="text-align: center; margin-top: 30px; font-size: 1.2em; color: #555; display: none;">
            </div>
    </div>

    <script>
        // エラーメッセージを表示するヘルパー関数
        function displayErrorMessage(message) {
            const loadingMessage = document.getElementById('loading-message');
            loadingMessage.textContent = message;
            loadingMessage.style.color = 'red'; // エラーは赤色で表示
            loadingMessage.style.display = 'block'; // メッセージを表示
        }

        // 通常メッセージを表示するヘルパー関数（認証中など）
        function displayInfoMessage(message) {
            const loadingMessage = document.getElementById('loading-message');
            loadingMessage.textContent = message;
            loadingMessage.style.color = '#555'; // 通常は標準の色
            loadingMessage.style.display = 'block'; // メッセージを表示
        }

        // Turnstileウィジェットをレンダリングする関数
        function onloadTurnstileCallback() {
            turnstile.render('#invisible-turnstile-container', {
                sitekey: '0x4AAAAAABls1fN8lpI4HllP', // ★ここにCloudflareダッシュボードで取得した実際のサイトキーを設定してください★
                callback: function(token) {
                    document.getElementById('cf-turnstile-response-hidden').value = token;
                    displayInfoMessage('認証中です...'); // 認証中のメッセージ
                    document.getElementById('captcha-form').style.display = 'none'; // フォームを非表示
                    document.getElementById('captcha-form').dispatchEvent(new Event('submit'));
                },
                'error-callback': function() {
                    // Turnstile自体でエラーが発生した場合
                    displayErrorMessage('セキュリティ認証中にエラーが発生しました。ページをリロードして再試行してください。');
                    document.getElementById('captcha-form').style.display = 'block'; // フォームを再表示
                },
                'expired-callback': function() {
                    turnstile.reset('#invisible-turnstile-container');
                    displayInfoMessage('認証の有効期限が切れました。再度お試しください...'); // 期限切れのメッセージ
                    document.getElementById('captcha-form').style.display = 'block'; // フォームを再表示
                },
                mode: 'managed'
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const captchaForm = document.getElementById('captcha-form');
            const loadingMessage = document.getElementById('loading-message'); // displayErrorMessage / displayInfoMessage が使う

            captchaForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const turnstileResponse = document.getElementById('cf-turnstile-response-hidden').value;

                if (turnstileResponse) {
                    displayInfoMessage('認証中です...'); // 認証中のメッセージ
                    captchaForm.style.display = 'none'; // フォームを非表示

                    try {
                        const response = await fetch('/verify-access', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: turnstileResponse })
                        });

                        const data = await response.json();

                        if (data.success && data.redirect) {
                            window.location.href = data.redirect; // 認証成功、情報ページへリダイレクト
                        } else {
                            // 検証失敗時のメッセージを具体的に
                            let errorMessage = '認証に失敗しました。';
                            if (data.error && Array.isArray(data.error) && data.error.length > 0) {
                                // サーバーからの特定のエラーコードがあれば表示
                                errorMessage += `原因: ${data.error.join(', ')}。`;
                            }
                            errorMessage += 'サイトキーとシークレットキーが正しく設定されているか確認してください。';
                            displayErrorMessage(errorMessage);
                            document.getElementById('captcha-form').style.display = 'block'; // フォームを再表示
                            if (typeof turnstile !== 'undefined') {
                                turnstile.reset('#invisible-turnstile-container'); // 失敗時はTurnstileをリセット
                            }
                        }
                    } catch (error) {
                        // ネットワークエラーなど、fetch自体が失敗した場合
                        console.error('認証エラー:', error); // 開発者ツール用
                        displayErrorMessage('認証中にネットワークエラーが発生しました。インターネット接続を確認して、ページをリロードしてください。');
                        document.getElementById('captcha-form').style.display = 'block'; // フォームを再表示
                    }
                } else {
                    // Turnstileトークンが取得できなかった場合（通常は発生しにくい）
                    displayErrorMessage('セキュリティ認証が完了していません。もう一度お試しください。');
                    document.getElementById('captcha-form').style.display = 'block'; // フォームを再表示
                }
            });
        });
    </script>
</body>
</html>